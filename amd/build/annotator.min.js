define(["jquery","jqueryui","core/ajax","core/str"],function(a,b,c,d){"use strict";function e(){var b={mode:a("#block_annotations-form-mode").val(),objectid:a("#block_annotations-form-objectid").val(),objecttype:a("#block_annotations-form-objecttype").val(),text:a("#block_annotations-form-text").val(),courseid:a("#block_annotations-form-courseid").val()};""!==a("#block_annotations-form-id").val()&&(b.id=a("#block_annotations-form-id").val());var d=c.call([{methodname:"block_annotations_annotate",args:b}]);d[0].done(function(b){a("#block_annotations-form-feedback").html('<div class="alert alert-success">Saved</div>');var c=b.objecttype+"_"+b.objectid;c in i||(i[c]=b,a("#block_annotations-form-id").val(b.id),a("#block_annotations-form-mode").val("edit")),i[c].text=a("#block_annotations-form-text").val()}).fail(function(){a("#block_annotations-form-feedback").html('<div class="alert alert-error">Failed !</div>')})}function f(a,b,c){var d="",e=b+"_"+c,f=o;e in i&&(d='data-id="'+i[e].id+'"',f=n),a.append('<div class="annotations"><span data-objecttype="'+b+'" data-objectid="'+c+'" '+d+' class="btn">'+f+"</span></div>")}function g(){a(".annotations span.btn").click(function(){var b=a(this).attr("data-id");if("undefined"!=typeof b&&b!==!1&&0!==b.lenght){var c=a(this).attr("data-objecttype")+"_"+a(this).attr("data-objectid");a("#block_annotations-form-id").val(b),a("#block_annotations-form-text").val(i[c].text),a("#block_annotations-form-mode").val("edit")}else a("#block_annotations-form-mode").val("add");a("#block_annotations-form-objectid").val(a(this).attr("data-objectid")),a("#block_annotations-form-objecttype").val(a(this).attr("data-objecttype")),j.dialog("open")})}function h(b,c){i=b,d.get_strings([{key:"add"},{key:"view"},{key:"edit"},{key:"cancel"},{key:"dialog_title",component:"block_annotations"}]).done(function(a){o=a[0],n=a[1],l=a[2],m=a[3],k=a[4]}),a("body").append('<div id="block_annotations-form" title="'+k+'"><form><fieldset><input id="block_annotations-form-mode" type="hidden" name="mode" value=""/><input id="block_annotations-form-id" type="hidden" name="id" value=""/><input id="block_annotations-form-objectid" type="hidden" name="objectid" value=""/><input id="block_annotations-form-objecttype" type="hidden" name="objecttype" value=""/><input id="block_annotations-form-courseid" type="hidden" name="courseid" value="'+c+'"/><textarea name="text" id="block_annotations-form-text" class="text ui-widget-content ui-corner-all" style="width: 300px; height: 150px;"></textarea><input type="submit" tabindex="-1" style="position:absolute; top:-1000px"></fieldset></form><div id="block_annotations-form-feedback"></div></div>'),j=a("#block_annotations-form").dialog({autoOpen:!1,height:400,width:350,modal:!0,buttons:[{text:l,click:e},{text:m,click:function(){j.dialog("close")}}],close:function(){j.find("form")[0].reset(),a("#block_annotations-form-text").val(""),a("#block_annotations-form-feedback").html("")}})}var i,j,k="add or update my annotation",l="edit",m="cancel",n="view",o="add";return{add:f,init:h,run:g}});